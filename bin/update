#!/usr/bin/env ruby

require 'fileutils'

include FileUtils

def run_command(command, silent: false)
  puts "\n== #{command} ==" unless silent
  system(silent ? "#{command} &> /dev/null" : command) || abort("\n== Command #{command} failed ==")
end

chdir File.expand_path('..', __dir__) do
  puts 'Updating...'

  # Make sure we're on the latest revision before running dependency updates
  run_command 'git pull'

  run_command 'bundle update --bundler && bundle update --all'

  # run_command 'yarn set version latest'

  run_command 'yarn upgrade-interactive'

  run_command 'rm yarn.lock && yarn install'

  run_command 'yarn run biome migrate --write', silent: true
end
